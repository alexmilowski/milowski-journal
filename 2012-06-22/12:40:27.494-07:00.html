<article xmlns="http://www.w3.org/1999/xhtml" vocab="http://schema.org/" typeof="BlogPosting" resource="http://www.milowski.com/journal/entry/2012-06-22T12:40:27.494000-07:00">
<script type="application/ld+json">
{
"@context" : "http://schema.org/",
"@id" : "http://www.milowski.com/journal/entry/2012-06-22T12:40:27.494000-07:00",
"@type" : "BlogPosting",
"genre" : "blog",
"headline" : "Disk Space is Important!",
"description" : "Sometimes you learn interesting things under duress, reaffirm things you already know, and pay for not doing it right the first time.",
"datePublished" : "2012-06-22T12:40:27.494000-07:00",
"dateModified" : "2012-06-22T12:40:27.494000-07:00",
"keywords" : "MarkLogic,AWS,EBS" ,
"author" : [ { "@type" : "Person", "name" : "Alex MiÅ‚owski" }]
}
</script>
<section class="info">

<div class="metadata">
<p>
<a href="http://www.milowski.com/journal/entry/2012-06-22T12:40:27.494000-07:00" title="link to this entry">ğŸ”—</a> Published on
<span property="datePublished" content="2012-06-22T12:40:27.494000-07:00">2012-06-22 12:40:27.494000-07:00</span>
<span property="dateModified" content="2012-06-22T12:40:27.494000-07:00"></span>
</p>
<p property="keywords">MarkLogic,AWS,EBS</p>
<p property="description">Sometimes you learn interesting things under duress, reaffirm things you already know, and pay for not doing it right the first time.</p>
</div>
</p>
<p property="author" typeof="Person"><span property="name">Alex MiÅ‚owski</span></p>
</section>
<h1>Disk Space is Important!</h1>
<p>Sometimes you learn interesting things under duress, reaffirm things you already know, and pay for not doing it right the first time.</p>
<p>It should come as no surprise that having enough disk space for MarkLogic is important but just what can happen when you run out was a bit of a surprise to me. Â In my on-going project to store  â€œbig weather dataâ€ , I have a constant stream of data flowing into MarkLogic. Â About every five minutes, new weather reports are inserted. Â While each set of reports are reasonable in side, the flow is constant such that the on-disk size of the forest grows by about 50GB a month.</p>
<p>My MarkLogic server runs in the cloud on an Amazon EC2 instance and I rationalized a smaller 300GB EBS volume was sufficient. Â I thought I would enlarge the disk when I needed to do so. Â Everything was working fine and so I didn't think too much about it again--rationalizing that I had awhile before I needed to be worried.</p>
<p>What was the worst that could happen? Â The database would go offline? Â Inserting new content would fail?</p>
<p>As an aside, there is a corollary to Murphy's law that says:  â€œWhen something goes wrong, you will be on vacation.â€ That's just what happened. Â I was on vacation last week, pulled up my application, and nothing was working. Â Poking around, I find that my MarkLogic server is inaccessible--really inaccessible. Â That is, I can't even get into the server via ssh.</p>
<p>I rebooted the server via the AWS Console and all hell broke loose. Â The server wouldn't boot because several of the EBS-based filesystems were corrupted. Â To make things even more frustrating, the server booted into single-user mode which, since it is virtualized and running in the cloud, is completely inaccessible. Â Viewing a system console where it asks you to type something, but you can't because you aren't anywhere near the actual machine, is very, very frustrating.</p>
<p>Making a long and arduous story short, I had to create new, small, empty filesystems and attach them as the devices that contained the corrupted filesystems, boot the server, and attempt to repair the old filesystems. Â What I found was that the superblock on the database filesystem was trashed as well as all the copies. Â Fortunately, I was able to retrieve the content using a wonderful program called <a href="http://www.cgsecurity.org/wiki/TestDisk">testdisk</a> .</p>
<p>I created a much larger 750GB filesystem on which I restored the database files and made a snapshot of the whole volume. Â Unfortunately, when I started MarkLogic, all my content had disappeared. Â Alternating between wanting to cry, for I had no recent backup, and use of colorful language, I had to dig in for the long haul and see if I could recover everything.</p>
<p>Looking at the logs for MarkLogic, I noticed it was deleting all my content on startup. Â I could repeat the process by creating a new filesystem from the snapshot, start MarkLogic, and watch it delete all my content. Â This is when I noticed the <code>Obsolete</code> files in all the stand directories where each forest was stored.</p>
<p>If you're a MarkLogic engineer, you should now brace yourself for getting the shivers.</p>
<p>I deleted the <code>Obsolete</code> files and started up MarkLogic to see what would happen.  Of course, it didn't quite work the first time. Â Turns out that the weather database still had problems but it didn't delete my website--this website that you are reading. Â I marked that as progress.</p>
<p>I assumed there was more serious damage to the forest for the weather database and asked my MarkLogic friends for some help. Turns out there some extra files hanging out in the forest directory--probably from a merge that was in progress. Â  There were empty files named like stand directories and also empty stand directories. Â I deleted these extra files, started up MarkLogic, and crossed my fingers.</p>
<p>MarkLogic took its time coming up and was rather silent about what was going on. Â I let it go for awhile and then, like wishing on a shooting star, my database came back up like nothing had happened.</p>
<p>I don't know exactly why the system went down as the system logs just stop. Â I do know that MarkLogic was complaining with critical errors about not having enough disk space to merge. Â Keep in mind that new content was continuously streaming in and so the problem was getting worse and worse. Â In the end, if I had to guess, I believe the OS just ran into some wall (like very low memory) and froze. Â When I rebooted it via the AWS console, it trashed the filesystem because the disks weren't sync'd.</p>
<p>My website is easy to backup and I'll do that more often now. Â The weather database is tricky because of its size. Â I'm looking into using automatic EBS snapshots by taking the database and filesystem offline for a moment. Â I can always re-create the weather database from scratch if I really need to do so as I have the raw XML source files but that would take quite awhile to do.</p>
<p>In the end, I was very lucky.</p>
</article>
